###############################################################################
#  Fail2ban Jail â€” Matrix Synapse + SSH + Nginx                               #
#  Comprehensive protection with incremental ban times                         #
###############################################################################

[DEFAULT]

# Ban awal 1 jam
bantime  = 1h

# Jika IP mengulang, durasi ban meningkat eksponensial
bantime.increment = true
bantime.factor = 2
bantime.formula = bantime * (1<<(ban_count if ban_count<20 else 20))

# Window deteksi
findtime = 10m
maxretry = 5

# Gunakan UFW
banaction = ufw

# Tambahkan Telegram alert
action = %(action_)s
         telegram

# Jangan ban IP lokal
ignoreip = 127.0.0.1/8 ::1


#################################################
# SSH Protection
#################################################

[sshd]
enabled = true
port    = 22
logpath = /var/log/auth.log
backend = systemd
maxretry = 5


#################################################
# NGINX HTTP Auth Protection
#################################################

[nginx-http-auth]
enabled = true
port    = http,https
logpath = /var/log/nginx/error.log


#################################################
# Matrix Synapse Login Protection (Nginx)
#################################################

[matrix-login]
enabled  = true
port     = http,https
filter   = matrix-login
logpath  = /var/log/nginx/access.log
maxretry = 5
findtime = 10m
bantime  = 1h


#################################################
# Matrix Synapse Direct Log Protection
#################################################

[matrix-synapse]
enabled  = true
filter   = matrix-synapse
port     = 443,8448
# This path will be updated by setup.sh
logpath  = /path/to/synapse-data/logs/homeserver.log
maxretry = 5
findtime = 600
bantime  = 3600


#################################################
# Matrix Federation Abuse (future ready)
#################################################

[matrix-federation]
enabled  = false
port     = http,https
filter   = matrix-federation
logpath  = /var/log/nginx/access.log
maxretry = 20
findtime = 10m
bantime  = 1h
