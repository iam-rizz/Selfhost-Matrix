###############################################################################
#  Fail2ban Action â€” Enhanced Telegram Notification                          #
#  Sends rich ban/unban alerts via Telegram Bot API with geolocation         #
#  Requires: TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID in .env                 #
###############################################################################

[Definition]

# Bot token and chat ID â€” set these or use setup.sh to configure
norestored = true

actionstart = /usr/bin/curl -s -X POST \
    "https://api.telegram.org/bot__TELEGRAM_BOT_TOKEN__/sendMessage" \
    -d "chat_id=__TELEGRAM_CHAT_ID__" \
    -d "parse_mode=HTML" \
    -d "text=ğŸŸ¢ <b>Fail2ban Started</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A<b>Jail:</b> <code><name></code>%0A<b>Server:</b> <code>$(hostname)</code>%0A<b>Time:</b> $(date '+%%Y-%%m-%%d %%H:%%M:%%S %%Z')%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0Aâœ… Protection active"

actionstop = /usr/bin/curl -s -X POST \
    "https://api.telegram.org/bot__TELEGRAM_BOT_TOKEN__/sendMessage" \
    -d "chat_id=__TELEGRAM_CHAT_ID__" \
    -d "parse_mode=HTML" \
    -d "text=ğŸ”´ <b>Fail2ban Stopped</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A<b>Jail:</b> <code><name></code>%0A<b>Server:</b> <code>$(hostname)</code>%0A<b>Time:</b> $(date '+%%Y-%%m-%%d %%H:%%M:%%S %%Z')%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0Aâš ï¸ Protection disabled"

actionban = /bin/bash -c '\
    IP="<ip>"; \
    GEOINFO=$(curl -s "https://ipapi.co/$IP/json/" 2>/dev/null); \
    CITY=$(echo "$GEOINFO" | jq -r ".city // \"Unknown\""); \
    REGION=$(echo "$GEOINFO" | jq -r ".region // \"Unknown\""); \
    COUNTRY=$(echo "$GEOINFO" | jq -r ".country_name // \"Unknown\""); \
    ORG=$(echo "$GEOINFO" | jq -r ".org // \"Unknown\""); \
    TIMEZONE=$(echo "$GEOINFO" | jq -r ".timezone // \"Unknown\""); \
    THREAT=$(echo "$GEOINFO" | jq -r ".threat // \"Unknown\""); \
    \
    if [ "$COUNTRY" = "Unknown" ]; then \
        LOCATION="ğŸŒ Location: <i>Unknown</i>"; \
    else \
        LOCATION="ğŸŒ Location: $CITY, $REGION, $COUNTRY"; \
    fi; \
    \
    if [ "$ORG" != "Unknown" ]; then \
        ORG_LINE="%0AğŸ¢ ISP/Org: <code>$ORG</code>"; \
    else \
        ORG_LINE=""; \
    fi; \
    \
    SEVERITY="ğŸŸ¡"; \
    if [ "<name>" = "sshd" ]; then \
        SEVERITY="ğŸ”´"; \
        JAIL_EMOJI="ğŸ”"; \
    elif [ "<name>" = "matrix-synapse" ]; then \
        SEVERITY="ğŸŸ "; \
        JAIL_EMOJI="ğŸ’¬"; \
    else \
        JAIL_EMOJI="ğŸ›¡ï¸"; \
    fi; \
    \
    /usr/bin/curl -s -X POST \
        "https://api.telegram.org/bot__TELEGRAM_BOT_TOKEN__/sendMessage" \
        -d "chat_id=__TELEGRAM_CHAT_ID__" \
        -d "parse_mode=HTML" \
        -d "text=$SEVERITY <b>SECURITY ALERT - IP BANNED</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A$JAIL_EMOJI <b>Service:</b> <code><name></code>%0AğŸš« <b>Banned IP:</b> <code>$IP</code>%0A$LOCATION$ORG_LINE%0Aâ° <b>Timezone:</b> $TIMEZONE%0AğŸ–¥ï¸ <b>Server:</b> <code>$(hostname)</code>%0AğŸ“… <b>Time:</b> $(date '+%%Y-%%m-%%d %%H:%%M:%%S %%Z')%0Aâ³ <b>Ban Duration:</b> <bantime> seconds%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0Aâš¡ <i>Automatic protection by Fail2ban</i>"; \
'

actionunban = /bin/bash -c '\
    IP="<ip>"; \
    GEOINFO=$(curl -s "https://ipapi.co/$IP/json/" 2>/dev/null); \
    CITY=$(echo "$GEOINFO" | jq -r ".city // \"Unknown\""); \
    COUNTRY=$(echo "$GEOINFO" | jq -r ".country_name // \"Unknown\""); \
    \
    if [ "$COUNTRY" = "Unknown" ]; then \
        LOCATION="ğŸŒ Location: <i>Unknown</i>"; \
    else \
        LOCATION="ğŸŒ Location: $CITY, $COUNTRY"; \
    fi; \
    \
    if [ "<name>" = "sshd" ]; then \
        JAIL_EMOJI="ğŸ”"; \
    elif [ "<name>" = "matrix-synapse" ]; then \
        JAIL_EMOJI="ğŸ’¬"; \
    else \
        JAIL_EMOJI="ğŸ›¡ï¸"; \
    fi; \
    \
    /usr/bin/curl -s -X POST \
        "https://api.telegram.org/bot__TELEGRAM_BOT_TOKEN__/sendMessage" \
        -d "chat_id=__TELEGRAM_CHAT_ID__" \
        -d "parse_mode=HTML" \
        -d "text=âœ… <b>IP UNBANNED</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A$JAIL_EMOJI <b>Service:</b> <code><name></code>%0AğŸ”“ <b>Unbanned IP:</b> <code>$IP</code>%0A$LOCATION%0AğŸ–¥ï¸ <b>Server:</b> <code>$(hostname)</code>%0AğŸ“… <b>Time:</b> $(date '+%%Y-%%m-%%d %%H:%%M:%%S %%Z')%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0Aâ™»ï¸ <i>Ban period expired</i>"; \
'

[Init]
name = default
