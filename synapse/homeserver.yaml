###############################################################################
#  Synapse Homeserver Configuration                                           #
#  Variables marked with __VAR__ are replaced by setup.sh from .env           #
###############################################################################

## Server ##
server_name: "__DOMAIN__"
public_baseurl: "https://__SYNAPSE_DOMAIN__/"
pid_file: /data/homeserver.pid
web_client_location: "https://__ELEMENT_SUBDOMAIN__.__DOMAIN__/"
serve_server_wellknown: true

## Worker Mode ##
# Instance map for worker coordination
instance_map:
  main:
    host: synapse
    port: 8008
  generic_worker1:
    host: synapse-worker-generic
    port: 8009
  media_worker:
    host: synapse-worker-media
    port: 8010

# Stream writers for event distribution
stream_writers:
  typing: generic_worker1
  to_device: generic_worker1
  account_data: generic_worker1
  receipts: generic_worker1
  presence: generic_worker1

# Federation sender instances
federation_sender_instances:
  - federation_sender1

# Disable media repo on main process (handled by worker)
enable_media_repo: false

## Networking ##
listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ["0.0.0.0"]
    resources:
      - names: [client, federation]
        compress: false
  - port: 9000
    type: metrics
    bind_addresses: ["0.0.0.0"]

## Database ##
database:
  name: psycopg2
  txn_limit: 10000
  args:
    user: "__POSTGRES_USER__"
    password: "__POSTGRES_PASSWORD__"
    database: "__POSTGRES_DB__"
    host: postgres
    port: 5432
    cp_min: 5
    cp_max: 10

## Caching ##
redis:
  enabled: true
  host: redis
  port: 6379
  password: "__REDIS_PASSWORD__"

caches:
  global_factor: 0.5
  per_cache_factors:
    get_users_in_room: 2.0

## Logging ##
log_config: "/data/log.config"

## Media ##
media_store_path: "/data/media_store"
max_upload_size: "__SYNAPSE_MAX_UPLOAD_SIZE__"
url_preview_enabled: true
url_preview_ip_range_blacklist:
  - "127.0.0.0/8"
  - "10.0.0.0/8"
  - "172.16.0.0/12"
  - "192.168.0.0/16"
  - "100.64.0.0/10"
  - "192.0.0.0/24"
  - "169.254.0.0/16"
  - "198.18.0.0/15"
  - "::1/128"
  - "fe80::/10"
  - "fc00::/7"
  - "2001:db8::/32"
  - "ff00::/8"
  - "fec0::/10"

## Registration ##
enable_registration: __SYNAPSE_ENABLE_REGISTRATION__
enable_registration_without_verification: true
registration_shared_secret: "__SYNAPSE_REGISTRATION_SHARED_SECRET__"

# reCAPTCHA protection (optional)
enable_registration_captcha: __ENABLE_REGISTRATION_CAPTCHA__
recaptcha_public_key: "__RECAPTCHA_PUBLIC_KEY__"
recaptcha_private_key: "__RECAPTCHA_PRIVATE_KEY__"

## Security ##
macaroon_secret_key: "__SYNAPSE_MACAROON_SECRET_KEY__"
form_secret: "__SYNAPSE_FORM_SECRET__"
signing_key_path: "/data/signing.key"

## Rate Limiting ##
rc_login:
  address:
    per_second: 0.1
    burst_count: 5
  account:
    per_second: 0.1
    burst_count: 5
  failed_attempts:
    per_second: 0.05
    burst_count: 3

rc_registration:
  per_second: 0.05
  burst_count: 3

rc_message:
  per_second: 5
  burst_count: 30

rc_federation:
  window_size: 1000
  sleep_limit: 10
  sleep_delay: 500
  reject_limit: 50
  concurrent: 3

## Federation ##
allow_public_rooms_over_federation: false
federation_domain_whitelist: null

## TURN (VoIP) ##
turn_uris:
  - "turn:__SYNAPSE_DOMAIN__:3478?transport=udp"
  - "turn:__SYNAPSE_DOMAIN__:3478?transport=tcp"
  - "turns:__SYNAPSE_DOMAIN__:5349?transport=udp"
  - "turns:__SYNAPSE_DOMAIN__:5349?transport=tcp"
turn_shared_secret: "__TURN_SECRET__"
turn_user_lifetime: 86400000
turn_allow_guests: false

## Metrics ##
enable_metrics: true
report_stats: false

## Presence ##
presence:
  enabled: true

## Room ##
encryption_enabled_by_default_for_room_type: "all"
allow_guest_access: false
default_room_version: "10"

## Retention ##
retention:
  enabled: true
  default_policy:
    min_lifetime: 1d
    max_lifetime: 365d
  allowed_lifetime_min: 1d
  allowed_lifetime_max: 365d

## Trusted Key Servers ##
trusted_key_servers:
  - server_name: "matrix.org"

suppress_key_server_warning: true

## Experimental Features ##
experimental_features:
  # Native Sliding Sync (MSC3575) - replaces external sliding-sync proxy
  msc3575_enabled: true
