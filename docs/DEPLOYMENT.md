# ðŸ“¦ Complete Deployment Guide

## Table of Contents

1. [Pre-Deployment Checklist](#pre-deployment-checklist)
2. [Server Setup](#server-setup)
3. [DNS Configuration](#dns-configuration)
4. [Installation Steps](#installation-steps)
5. [Post-Deployment](#post-deployment)
6. [Verification](#verification)

---

## Pre-Deployment Checklist

### Server Requirements

**Minimum Specifications:**
- **CPU:** 2 cores
- **RAM:** 4GB (8GB recommended for production)
- **Disk:** 20GB (SSD recommended)
- **OS:** Ubuntu 20.04+, Debian 11+, or any Linux with Docker support

**Network Requirements:**
- **Public IP:** Static IP address
- **Domain:** Registered domain name
- **Ports:** 80, 443, 3478, 5349, 49152-50151 accessible from internet

### Domain Preparation

You need a domain with the following subdomains:

| Subdomain | Purpose | Example |
|-----------|---------|---------|
| `@` (root) | Synapse homeserver | `two.web.id` |
| `element` | Element web client | `element.two.web.id` |
| `dimension` | Integration manager | `dimension.two.web.id` |
| `meet` | Jitsi video conferencing | `meet.two.web.id` |
| `traefik` | Traefik dashboard | `traefik.two.web.id` |

---

## Server Setup

### 1. Update System

```bash
# Update package lists
sudo apt update

# Upgrade installed packages
sudo apt upgrade -y

# Install essential tools
sudo apt install -y curl git nano htop ufw
```

### 2. Install Docker

```bash
# Download Docker installation script
curl -fsSL https://get.docker.com -o get-docker.sh

# Run installation
sudo sh get-docker.sh

# Add current user to docker group
sudo usermod -aG docker $USER

# Apply group changes
newgrp docker

# Verify installation
docker --version
```

### 3. Install Docker Compose

```bash
# Install Docker Compose plugin
sudo apt install -y docker-compose-plugin

# Verify installation
docker compose version
```

### 4. Configure Firewall

```bash
# Install UFW if not already installed
sudo apt install -y ufw

# Set default policies
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow SSH (IMPORTANT: Do this first!)
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS for Traefik
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Allow Coturn TURN/STUN
sudo ufw allow 3478/tcp
sudo ufw allow 3478/udp
sudo ufw allow 5349/tcp
sudo ufw allow 5349/udp
sudo ufw allow 49152:50151/udp

# Enable firewall
sudo ufw enable

# Check status
sudo ufw status verbose
```

---

## DNS Configuration

### Configure DNS Records

Log in to your domain registrar or DNS provider and create the following records:

#### A Records

| Type | Name | Value | TTL |
|------|------|-------|-----|
| A | `@` | `YOUR_SERVER_IP` | 300 |
| A | `element` | `YOUR_SERVER_IP` | 300 |
| A | `dimension` | `YOUR_SERVER_IP` | 300 |
| A | `meet` | `YOUR_SERVER_IP` | 300 |
| A | `traefik` | `YOUR_SERVER_IP` | 300 |

#### SRV Record (for Federation)

| Type | Name | Value | Priority | Weight | Port | TTL |
|------|------|-------|----------|--------|------|-----|
| SRV | `_matrix._tcp` | `your-domain.com` | 10 | 0 | 8448 | 300 |

### Verify DNS Propagation

```bash
# Check A record
dig your-domain.com +short

# Check subdomain
dig element.your-domain.com +short

# Check SRV record
dig _matrix._tcp.your-domain.com SRV +short
```

**Wait 5-10 minutes** for DNS propagation before proceeding.

---

## Installation Steps

### 1. Clone Repository

```bash
# Clone from GitHub
git clone https://github.com/iam-rizz/Selfhost-Matrix.git

# Navigate to directory
cd Selfhost-Matrix

# Check files
ls -la
```

### 2. Configure Environment

```bash
# Copy example configuration
cp .env.example .env

# Edit configuration
nano .env
```

**Required Configuration:**

```bash
##############################################
#  Matrix Server Configuration               #
##############################################

# === Domain Configuration ===
USE_ROOT_DOMAIN=true  # true = Synapse at root domain, false = subdomain
DOMAIN=your-domain.com
SYNAPSE_SUBDOMAIN=chat
ELEMENT_SUBDOMAIN=element
DIMENSION_SUBDOMAIN=dimension

# === SSL Configuration ===
ACME_EMAIL=admin@your-domain.com  # For Let's Encrypt notifications

# === PostgreSQL ===
POSTGRES_USER=synapse
POSTGRES_PASSWORD=CHANGE_ME_STRONG_PASSWORD_HERE
POSTGRES_DB=synapse

# === Redis ===
REDIS_PASSWORD=CHANGE_ME_STRONG_PASSWORD_HERE

# === Synapse ===
SYNAPSE_ENABLE_REGISTRATION=true  # Set to false after creating users
# Other Synapse secrets will be auto-generated by setup.sh

# === Traefik Dashboard ===
TRAEFIK_DASHBOARD_USER=admin
# Generate password with: ./scripts/generate-traefik-password.sh
TRAEFIK_DASHBOARD_PASSWORD=CHANGE_ME_BCRYPT_HASH_HERE

# === Coturn ===
# TURN_SECRET will be auto-generated by setup.sh
TURN_MIN_PORT=49152
TURN_MAX_PORT=50151  # 1000 ports (optimized to prevent memory leak)

# === Grafana ===
GF_SECURITY_ADMIN_USER=admin
GF_SECURITY_ADMIN_PASSWORD=CHANGE_ME_STRONG_PASSWORD_HERE

# === pgAdmin ===
PGADMIN_DEFAULT_EMAIL=admin@your-domain.com
PGADMIN_DEFAULT_PASSWORD=CHANGE_ME_STRONG_PASSWORD_HERE
```

### 3. Generate Traefik Dashboard Password

```bash
# Run password generator
./scripts/generate-traefik-password.sh

# Enter your desired password when prompted
# Copy the bcrypt hash output

# Paste into .env
nano .env
# Update: TRAEFIK_DASHBOARD_PASSWORD=<bcrypt-hash>
```

### 4. Run Setup Script

```bash
# Make setup script executable
chmod +x setup.sh

# Run setup
./setup.sh
```

**What setup.sh does:**
1. âœ… Creates all required directories
2. âœ… Generates random secrets for services
3. âœ… Substitutes environment variables in config files
4. âœ… Fixes permissions for Prometheus, Grafana, pgAdmin, Dimension
5. âœ… Validates configuration
6. âœ… Shows deployment summary

**Expected Output:**
```
âœ“ Created directory: synapse-data
âœ“ Created directory: postgres-data
âœ“ Created directory: redis-data
...
âœ“ Generated SYNAPSE_REGISTRATION_SHARED_SECRET
âœ“ Generated SYNAPSE_MACAROON_SECRET_KEY
...
âœ“ Substituted variables in synapse/homeserver.yaml
âœ“ Substituted variables in element/config.json
...
âœ“ Fixed Prometheus permissions
âœ“ Fixed Grafana permissions
...

=== Setup Complete ===
Next steps:
1. Review .env file
2. Run: docker compose up -d
3. Create admin user
```

### 5. Start Services

```bash
# Pull Docker images (first time only)
docker compose pull

# Start all services in detached mode
docker compose up -d

# Watch logs (optional)
docker compose logs -f

# Press Ctrl+C to stop watching logs
```

### 6. Verify Services Started

```bash
# Check all containers
docker compose ps

# Should show all services as "Up" or "healthy"
```

**Expected Output:**
```
NAME                                  STATUS
matrix-alertmanager                   Up
matrix-coturn                         Up
matrix-dimension                      Up
matrix-element                        Up
matrix-grafana                        Up
matrix-jitsi-jicofo                   Up
matrix-jitsi-jvb                      Up
matrix-jitsi-prosody                  Up
matrix-jitsi-web                      Up
matrix-node-exporter                  Up
matrix-pgadmin                        Up
matrix-postgres                       Up (healthy)
matrix-prometheus                     Up
matrix-redis                          Up
matrix-sliding-sync                   Up
matrix-synapse                        Up
matrix-synapse-admin                  Up
matrix-synapse-worker-federation-sender  Up
matrix-synapse-worker-generic         Up
matrix-synapse-worker-media           Up
matrix-traefik                        Up
```

---

## Post-Deployment

### 1. Create Admin User

```bash
# Register first user (will be admin)
docker exec -it matrix-synapse register_new_matrix_user \
    -c /data/homeserver.yaml \
    http://localhost:8008
```

**Interactive Prompts:**
```
New user localpart [root]: admin
Password: <enter-strong-password>
Confirm password: <enter-same-password>
Make admin [no]: yes
Sending registration request...
Success!
```

### 2. Create Dimension Bot User

```bash
# Create dimension user
docker exec -it matrix-synapse register_new_matrix_user \
    -c /data/homeserver.yaml \
    http://localhost:8008

# Prompts:
# Username: dimension
# Password: <dimension-password>
# Admin: no
```

**Get Dimension Access Token:**

```bash
# Login to get access token
curl -s -X POST "http://localhost:8008/_matrix/client/r0/login" \
    -H "Content-Type: application/json" \
    -d '{"type":"m.login.password","user":"dimension","password":"<dimension-password>"}' \
    | jq -r '.access_token'

# Copy the access token output
```

**Update .env with token:**

```bash
nano .env
# Add: DIMENSION_ACCESS_TOKEN=<token-from-above>

# Regenerate configs
./setup.sh

# Restart Dimension
docker compose up -d dimension
```

### 3. Disable Public Registration (Optional)

After creating all needed users:

```bash
nano .env
# Change: SYNAPSE_ENABLE_REGISTRATION=false

# Regenerate configs
./setup.sh

# Restart Synapse
docker compose up -d synapse
```

---

## Verification

### 1. Check SSL Certificates

```bash
# Check Traefik logs for ACME
docker logs matrix-traefik | grep -i acme

# Should see: "Certificate obtained for domain"
```

**Access via browser:**
- `https://your-domain.com` - Should show Synapse JSON response
- `https://element.your-domain.com` - Should show Element login page

### 2. Test Federation

**Matrix Federation Tester:**

Visit: `https://federationtester.matrix.org/api/report?server_name=your-domain.com`

**Should show:**
- âœ… DNS SRV record found
- âœ… Server reachable
- âœ… Valid SSL certificate
- âœ… Federation working

### 3. Access Services

| Service | URL | Credentials |
|---------|-----|-------------|
| **Element Web** | `https://element.your-domain.com` | Matrix user |
| **Synapse Admin** | `http://localhost:8888` | Matrix admin user |
| **Traefik Dashboard** | `https://traefik.your-domain.com/dashboard/` | From `.env` |
| **Grafana** | `http://localhost:3000` | admin / GF_SECURITY_ADMIN_PASSWORD |
| **Prometheus** | `http://localhost:9090` | No auth |
| **pgAdmin** | `http://localhost:5050` | PGADMIN_DEFAULT_EMAIL / PASSWORD |

### 4. Test Voice/Video Calls

1. Login to Element with 2 different users
2. Start a voice or video call
3. Verify Coturn is working:

```bash
# Check Coturn logs
docker logs matrix-coturn

# Should see TURN allocations when call starts
```

### 5. Monitor Resources

```bash
# Check container resource usage
docker stats

# Check system resources
htop

# Check disk usage
df -h
```

**Expected Memory Usage:**
- Total system: 2-4GB
- Coturn: 50-100MB (NOT 16GB!)
- Synapse: 500MB-1GB
- PostgreSQL: 200-400MB
- Others: < 100MB each

---

## Troubleshooting

### Issue: Containers Not Starting

```bash
# Check logs
docker compose logs

# Check specific service
docker logs matrix-synapse

# Restart specific service
docker compose restart synapse
```

### Issue: SSL Certificate Not Generating

```bash
# Check Traefik logs
docker logs matrix-traefik | grep -i error

# Verify DNS
dig your-domain.com +short

# Check ports 80 and 443 are open
sudo ufw status | grep -E "80|443"

# Restart Traefik
docker compose restart traefik
```

### Issue: Permission Denied Errors

```bash
# Fix all permissions
./setup.sh

# Or manually:
chmod -R 777 prometheus-data
chmod -R 777 grafana-data
chmod -R 777 pgadmin-data
chmod -R 777 dimension

# Restart affected services
docker compose up -d
```

### Issue: Coturn Memory Leak

```bash
# Verify host network mode
docker inspect matrix-coturn | grep NetworkMode
# Should show: "NetworkMode": "host"

# Check memory usage
docker stats matrix-coturn --no-stream
# Should be < 100MB

# If still high, pull latest code
git pull origin main
docker compose up -d coturn
```

---

## Next Steps

1. **Configure Monitoring:** Setup Grafana dashboards
2. **Setup Backups:** Configure automated backups
3. **Invite Users:** Share Element URL with users
4. **Join Rooms:** Join Matrix community rooms
5. **Configure Bridges:** Setup Telegram, Discord, etc. bridges

---

## Support

- **Documentation:** [README.md](../README.md)
- **Issues:** [GitHub Issues](https://github.com/iam-rizz/Selfhost-Matrix/issues)
- **Matrix Room:** `#selfhost-matrix:your-domain.com`

---

**Deployment Complete! ðŸŽ‰**
